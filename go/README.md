# üêø RedStone SmartWeave contracts - Go template

Following repository is a template for writing SmartWeave contracts in Go and building them into WASM binaries which can be then processed by RedStone SmartWeave SDK.

It contains an example implementation of a PST contract - which you can use as a base for implementing your own contract.
If you are not familiar with the concept of Profit Sharing Tokens, check out a [tutorial](https://redstone.academy/docs/pst/introduction/intro) for writing your first PST contract in our RedStone Academy.

- [Installation](#installation)
- [Code structure](#code-structure)
- [Writing contract](#writing-contract)
- [Build](#build)
- [Tests](#tests)
- [Deploy](#deploy)
- [Using SDK](#using-sdk)

## üì¶ Installation

You will need:
- Go :-) (https://go.dev/doc/install)
- [tinygo](https://tinygo.org/getting-started/install/) (a compiler that produces much smaller binaries (up to 10x) than the default Go compiler)
- [easyjson](https://github.com/mailru/easyjson#install) (a code generation tool for handling json marshalling/unmarshalling)
- [Node.js](https://nodejs.org/en/download/) version 16.5 or above
- [yarn](https://yarnpkg.com/getting-started/install) installed

To install all Node.js dependencies run the following command:
```bash
yarn install
```

## üîç Code structure
- [deploy/](deploy) - contains deployment scripts for localhost/testnet/mainnet and contract's initial state definition
- [.out/](.out) - generated by `tinygo` compiler during build process - contains compiled wasm binary
- [src/](src) - contains the source code of the contract
    - [common/](src/common) - package for commons code, that will be reused between contracts (
      handles the low-level WASM-JS communication for Go). Contains `SwContract` interface
      that has to implemented by contract developers.  
      üî•Do Not Editüî•, unless you really know what you're doing :-)
    - [common_types/](src/common_types) - package for commons structs. Have to be a separate package,
      otherwise `easyjson` throws error during code generation
    - [impl/](src/impl) - package that contains implementation of the given contract (i.e. implementation of the `SwContract`
      interface)
        - [impl/contract.go](src/impl/contract.go) - contains the logic of the contract, e.g. mapping from actions to functions,
          that will be called
        - [impl/actions.go](src/impl/actions.go) - contains the logic of all the contract's functions.
    - [types/](src/types) - contains definition of all the types used by the contract (state, actions schemas, etc)
    - [main.go](src/main.go) - entry point for the contract. Initialises contract's module and registers it on host.
- [tests/](tests) - contains integration tests written in Jest

## üßë‚Äçüíª Writing contract

If you want to edit contract's code and create your own implementation you can do it by following these steps:

1. Edit `init-state.json` by adding the initial state for your contract - [deploy/state/init-state.json](deploy/state/init-state.json)
2. Modify the state definition of the contract - [src/types/types.go](src/types/types.go).    
   Add schemas which should describe input and output types for your actions - [src/types/types.go](src/types/types.go).  
Each time you change the definitions in the file above, run
```bash
yarn generate
```
3. Edit/add actions which user will be able to call while interacting with the contract - [src/impl/actions](src/impl/actions.go).
4. Add above action functions to the pattern matching in `Handle` function in [src/impl/contract.go](src/impl/contract.go#L16)

### üë∑ Build
Compile your contract to WASM binary by running following command:

```bash
yarn build
```
This command will both generate the code for the json marshalling/unmarshalling and compile the contract with `tinygo` compiler. 

### üß™ Tests
Write tests for your contract (we will use Jest library for testing) - you can find a template in the [tests/](tests) folder.
Run tests with
```bash
yarn test
```

### üìú Deploy
Deploy your contract to one of the networks (mainnet/RedStone public testnet/localhost) by running following command (`network`: `mainnet` | `testnet` | `local`)

```bash
yarn deploy:[network]
```

üí°**NOTE**: If you want to deploy your contract locally you need to run Arlocal by typing following command:

```bash
npx arlocal
```

üí°**NOTE**: When using mainnet please put your wallet key in [deploy/mainnet/.secrets/wallet-mainnet.json](deploy/mainnet/.secrets/wallet-mainnet.json). `.secrets` folder has been added to `.gitignore` so your key is kept securely.

You can view deploy script code [here](deploy/scripts/deploy.js).

### Using SDK
Using RedStone SmartWeave SDKs' methods is similar to how you should use them in case of regular JS contracts. You can run a script which compiles contract, deploys it and reads its state by running:

```bash
yarn read:[network]
```

If you would like to view `read-contract-state.js` script code you can check it out [here](deploy/scripts/read-contract-state.js).

